const g="https://api.ethos.network/api/v2",p="ethoscan@1.0.0";async function y(e){try{const t=await fetch(`${g}/users/by/address`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"*/*","X-Ethos-Client":p},body:JSON.stringify({addresses:[e]})});if(!t.ok)return t.status===404?{success:!1,error:{message:"Address not found in Ethos network",statusCode:404}}:t.status===400?{success:!1,error:{message:"Invalid Ethereum address format",statusCode:400}}:{success:!1,error:{message:`API request failed with status ${t.status}`,statusCode:t.status}};const r=await t.json();return!r||r.length===0?{success:!1,error:{message:"No profile data returned from API",statusCode:404}}:{success:!0,data:r[0]}}catch(t){return{success:!1,error:{message:t instanceof Error?t.message:"Network request failed",statusCode:0}}}}function v(e){return typeof e!="number"||isNaN(e)||!isFinite(e)?0:Math.floor(Math.max(0,Math.min(2800,e)))}function E(e){return e<800?{level:"untrusted",color:"#b72b38"}:e<1200?{level:"questionable",color:"#C29010"}:e<1400?{level:"neutral",color:"#C1C0B6"}:e<1600?{level:"known",color:"#7C8DA8"}:e<1800?{level:"established",color:"#4E86B9"}:e<2e3?{level:"reputable",color:"#2E7BC3"}:e<2200?{level:"exemplary",color:"#427B56"}:e<2400?{level:"distinguished",color:"#127f31"}:e<2600?{level:"revered",color:"#836DA6"}:{level:"renowned",color:"#7A5EAF"}}function b(e){const t=v(e.score),{level:r,color:n}=E(t),o=e.status==="active",l={negative:e.stats?.review?.received?.negative??0,neutral:e.stats?.review?.received?.neutral??0,positive:e.stats?.review?.received?.positive??0},s=d=>d&&d.trim()!==""?d:void 0;return{score:t,level:r,color:n,isActive:o,displayName:s(e.displayName),username:s(e.username),avatarUrl:s(e.avatarUrl),reviewStats:l,links:{profile:e.links.profile,scoreBreakdown:e.links.scoreBreakdown}}}function i(e){if(!document.contains(e))return!1;const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden")return!1;const r=e.getBoundingClientRect();if(r.width===0||r.height===0)return!1;let n=e.parentElement;for(;n;){const o=window.getComputedStyle(n);if(o.display==="none"||o.visibility==="hidden")return!1;n=n.parentElement}return!0}function m(e,t=3e3){return new Promise(r=>{const n=document.querySelector(e);if(n&&i(n)){r(n);return}const o=new MutationObserver(()=>{const s=document.querySelector(e);s&&i(s)&&(o.disconnect(),clearTimeout(l),r(s))});o.observe(document.body,{childList:!0,subtree:!0});const l=setTimeout(()=>{o.disconnect(),r(null)},t)})}function w(e){switch(e){case"etherscan":return{explorer:e,selectors:[{query:"#ContentPlaceHolder1_divSummary",strategy:"prepend"},{query:"#ContentPlaceHolder1_divENSName",strategy:"after"},{query:"section.container-xxl",strategy:"prepend"}],fallbackSelector:"main#content",maxRetries:3};case"blockscout":return{explorer:e,selectors:[{query:".address-entity",strategy:"after"},{query:'a[href*="/name-services/domains/"]',strategy:"after"}],fallbackSelector:"main",waitForDynamicContent:!0,maxRetries:5};case"debank":return{explorer:e,selectors:[{query:'[class*="ProfileHeader"]',strategy:"append"},{query:'[class*="UserInfo"]',strategy:"after"},{query:"main > div:first-child",strategy:"prepend"}],fallbackSelector:"main",waitForDynamicContent:!0,maxRetries:5};default:return{explorer:e,selectors:[],maxRetries:3}}}async function S(e){const t=w(e);console.group(`[Ethoscan] Finding anchor for ${e}`);for(const n of t.selectors){console.log("Trying selector:",n.query);let o=null;if(t.waitForDynamicContent?o=await m(n.query,3e3):o=document.querySelector(n.query),o){const l=i(o);if(console.log("Element found:",!0),console.log("Validation passed:",l),l){if(n.validator&&!n.validator(o)){console.log("Custom validator failed");continue}return console.log("✓ Primary selector matched (high confidence)"),console.groupEnd(),{element:o,insertionStrategy:n.strategy,confidence:"high"}}}else console.log("Element found:",!1)}if(t.fallbackSelector){console.log("Trying fallback selector:",t.fallbackSelector);let n=null;if(t.waitForDynamicContent?n=await m(t.fallbackSelector,3e3):n=document.querySelector(t.fallbackSelector),n&&i(n))return console.log("✓ Fallback selector matched (medium confidence)"),console.groupEnd(),{element:n,insertionStrategy:"prepend",confidence:"medium"}}const r=["main","body"];for(const n of r){console.log("Trying generic selector:",n);const o=document.querySelector(n);if(o&&i(o))return console.warn("⚠ Using generic selector (low confidence)"),console.groupEnd(),{element:o,insertionStrategy:"prepend",confidence:"low"}}return console.error("✗ No anchor point found"),console.groupEnd(),null}function k(e){return!e||typeof e!="string"||!e.startsWith("0x")||e.length!==42?!1:/^0x[0-9a-fA-F]{40}$/.test(e)}function C(e){try{const r=new URL(e).hostname.toLowerCase();return r==="etherscan.io"||r.endsWith(".etherscan.io")?"etherscan":r==="blockscout.com"||r.endsWith(".blockscout.com")?"blockscout":r==="debank.com"?"debank":null}catch{return null}}function A(e){const t=C(e);if(!t)return{address:null,explorer:null,isValid:!1};try{const n=new URL(e).pathname;let o=null;if(t==="etherscan"||t==="blockscout"){const s=n.match(/\/address\/([^\/\?#]+)/);s&&s[1]&&(o=s[1])}else if(t==="debank"){const s=n.match(/\/profile\/([^\/\?#]+)/);s&&s[1]&&(o=s[1])}if(!o)return{address:null,explorer:t,isValid:!1};const l=k(o);return{address:l?o:null,explorer:t,isValid:l}}catch{return{address:null,explorer:t,isValid:!1}}}let c=null,u=null,a=null;async function f(){const e=A(window.location.href);if(e.isValid&&e.address&&e.explorer){if(e.address===c)return;c=e.address,console.log(`[Ethoscan] Address detected: ${e.address} on ${e.explorer}`);const t=await S(e.explorer);if(!t){console.error(`[Ethoscan] Failed to find DOM anchor point for ${e.explorer}`);return}console.log(`[Ethoscan] Found anchor point with ${t.confidence} confidence`);const r=await y(e.address);if(r.success){const n=b(r.data);console.log("[Ethoscan] Normalized Ethos profile:",n)}else console.error("[Ethoscan] Failed to fetch Ethos profile:",r.error)}else c!==null&&(c=null,console.log("[Ethoscan] No valid Ethereum address found in URL"))}function q(){a=()=>{f()},window.addEventListener("popstate",a),u=window.setInterval(()=>{f()},500)}function P(){a!==null&&(window.removeEventListener("popstate",a),a=null),u!==null&&(clearInterval(u),u=null)}function h(){f(),q()}window.addEventListener("beforeunload",P);document.readyState==="loading"?document.addEventListener("DOMContentLoaded",h):h();
