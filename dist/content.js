const S="https://api.ethos.network/api/v2",k="ethoscan@1.0.0";async function _(e){try{const t=await fetch(`${S}/users/by/address`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"*/*","X-Ethos-Client":k},body:JSON.stringify({addresses:[e]})});if(!t.ok)return t.status===404?{success:!1,error:{message:"Address not found in Ethos network",statusCode:404}}:t.status===400?{success:!1,error:{message:"Invalid Ethereum address format",statusCode:400}}:{success:!1,error:{message:`API request failed with status ${t.status}`,statusCode:t.status}};const o=await t.json();return!o||o.length===0?{success:!1,error:{message:"No profile data returned from API",statusCode:404}}:{success:!0,data:o[0]}}catch(t){return{success:!1,error:{message:t instanceof Error?t.message:"Network request failed",statusCode:0}}}}function x(e){return typeof e!="number"||isNaN(e)||!isFinite(e)?0:Math.floor(Math.max(0,Math.min(2800,e)))}function A(e){return e<800?{level:"untrusted",color:"#b72b38"}:e<1200?{level:"questionable",color:"#C29010"}:e<1400?{level:"neutral",color:"#C1C0B6"}:e<1600?{level:"known",color:"#7C8DA8"}:e<1800?{level:"established",color:"#4E86B9"}:e<2e3?{level:"reputable",color:"#2E7BC3"}:e<2200?{level:"exemplary",color:"#427B56"}:e<2400?{level:"distinguished",color:"#127f31"}:e<2600?{level:"revered",color:"#836DA6"}:{level:"renowned",color:"#7A5EAF"}}function q(e){const t=x(e.score),{level:o,color:n}=A(t),r=e.status==="active",a={negative:e.stats?.review?.received?.negative??0,neutral:e.stats?.review?.received?.neutral??0,positive:e.stats?.review?.received?.positive??0},s=i=>i&&i.trim()!==""?i:void 0;return{score:t,level:o,color:n,isActive:r,displayName:s(e.displayName),username:s(e.username),avatarUrl:s(e.avatarUrl),reviewStats:a,links:{profile:e.links.profile,scoreBreakdown:e.links.scoreBreakdown}}}function d(e){if(!document.contains(e))return!1;const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden")return!1;const o=e.getBoundingClientRect();if(o.width===0||o.height===0)return!1;let n=e.parentElement;for(;n;){const r=window.getComputedStyle(n);if(r.display==="none"||r.visibility==="hidden")return!1;n=n.parentElement}return!0}function y(e,t=3e3){return new Promise(o=>{const n=document.querySelector(e);if(n&&d(n)){o(n);return}const r=new MutationObserver(()=>{const s=document.querySelector(e);s&&d(s)&&(r.disconnect(),clearTimeout(a),o(s))});r.observe(document.body,{childList:!0,subtree:!0});const a=setTimeout(()=>{r.disconnect(),o(null)},t)})}function I(e){switch(e){case"etherscan":return{explorer:e,selectors:[{query:".container.py-3",strategy:"after"},{query:"section.container-xxl",strategy:"after"},{query:"#ContentPlaceHolder1_divSummary",strategy:"prepend"}],fallbackSelector:"main#content",maxRetries:3};case"blockscout":return{explorer:e,selectors:[{query:".address-entity",strategy:"after"},{query:'a[href*="/name-services/domains/"]',strategy:"after"}],fallbackSelector:"main",waitForDynamicContent:!0,maxRetries:5};case"debank":return{explorer:e,selectors:[{query:'[class*="ProfileHeader"]',strategy:"append"},{query:'[class*="UserInfo"]',strategy:"after"},{query:"main > div:first-child",strategy:"prepend"}],fallbackSelector:"main",waitForDynamicContent:!0,maxRetries:5};default:return{explorer:e,selectors:[],maxRetries:3}}}async function L(e){const t=I(e);console.group(`[Ethoscan] Finding anchor for ${e}`);for(const n of t.selectors){console.log("Trying selector:",n.query);let r=null;if(t.waitForDynamicContent?r=await y(n.query,3e3):r=document.querySelector(n.query),r){const a=d(r);if(console.log("Element found:",!0),console.log("Validation passed:",a),a){if(n.validator&&!n.validator(r)){console.log("Custom validator failed");continue}return console.log("✓ Primary selector matched (high confidence)"),console.groupEnd(),{element:r,insertionStrategy:n.strategy,confidence:"high"}}}else console.log("Element found:",!1)}if(t.fallbackSelector){console.log("Trying fallback selector:",t.fallbackSelector);let n=null;if(t.waitForDynamicContent?n=await y(t.fallbackSelector,3e3):n=document.querySelector(t.fallbackSelector),n&&d(n))return console.log("✓ Fallback selector matched (medium confidence)"),console.groupEnd(),{element:n,insertionStrategy:"prepend",confidence:"medium"}}const o=["main","body"];for(const n of o){console.log("Trying generic selector:",n);const r=document.querySelector(n);if(r&&d(r))return console.warn("⚠ Using generic selector (low confidence)"),console.groupEnd(),{element:r,insertionStrategy:"prepend",confidence:"low"}}return console.error("✗ No anchor point found"),console.groupEnd(),null}function P(e){const t=e.replace("#",""),o=parseInt(t.substr(0,2),16)/255,n=parseInt(t.substr(2,2),16)/255,r=parseInt(t.substr(4,2),16)/255,[a,s,i]=[o,n,r].map(l=>l<=.03928?l/12.92:Math.pow((l+.055)/1.055,2.4));return .2126*a+.7152*s+.0722*i}function C(e){return P(e)>.179?"#000000":"#ffffff"}function N(){const e=document.documentElement,t=e.getAttribute("data-bs-theme");if(t==="dark")return"dark";if(t==="dim")return"dim";if(e.classList.contains("dark")||document.body.classList.contains("dark"))return"dark";const r=window.getComputedStyle(document.body).backgroundColor.match(/\d+/g);if(r&&r.length>=3){const a=parseInt(r[0]),s=parseInt(r[1]),i=parseInt(r[2]),l=(.299*a+.587*s+.114*i)/255;return l<.3?"dark":l<.6?"dim":"light"}return"light"}function T(e){switch(e){case"etherscan":return N();case"blockscout":return"dark";case"debank":return"light";default:return"light"}}const m="ethoscan-widget",v="data-ethoscan-id";function b(e,t,o,n){requestAnimationFrame(()=>{E();const r=T(n),s=e?R(e,n,r,n==="etherscan"):M("Unable to load Ethos profile");s.setAttribute(v,o.toLowerCase()),s.setAttribute("data-ethoscan-explorer",n),s.setAttribute("data-ethoscan-theme",r),W(s,t)})}function R(e,t,o,n){if(n){const r=document.createElement("section");r.className="container py-3",r.setAttribute(v,"");const a=B(e);return r.appendChild(a),r}else{const r=c("div",m),a=$(e),s=F(e);return r.appendChild(a),r.appendChild(s),r}}function $(e){const t=c("div","ethoscan-widget__header"),o=c("span","ethoscan-widget__title","Ethos Reputation"),n=document.createElement("a");return n.className="ethoscan-widget__link",n.href=e.links.profile,n.target="_blank",n.rel="noopener noreferrer",n.textContent="View Profile",t.appendChild(o),t.appendChild(n),t}function F(e){const t=c("div","ethoscan-widget__content"),o=D(e),n=j(e);return t.appendChild(o),t.appendChild(n),t}function D(e){const t=c("div","ethoscan-widget__score-section"),o=c("div","ethoscan-widget__score");o.style.color=e.color,o.style.textShadow="0 0 8px rgba(255, 255, 255, 0.9), 0 0 2px rgba(0, 0, 0, 0.3)",o.textContent=e.score.toString();const n=c("div","ethoscan-widget__level");return n.style.backgroundColor=e.color,n.style.color=C(e.color),n.textContent=e.level,t.appendChild(o),t.appendChild(n),t}function j(e){const t=c("div","ethoscan-widget__stats"),o=e.reviewStats.positive,n=e.reviewStats.neutral,r=e.reviewStats.negative,a=g(o.toString(),"Positive"),s=g(n.toString(),"Neutral"),i=g(r.toString(),"Negative");return t.appendChild(a),t.appendChild(s),t.appendChild(i),t}function g(e,t){const o=c("div","ethoscan-widget__stat"),n=c("span","ethoscan-widget__stat-value",e),r=c("span","ethoscan-widget__stat-label",t);return o.appendChild(n),o.appendChild(r),o}function B(e){const t=c("div","card h-100 mb-3"),o=c("div","card-body d-flex flex-row flex-wrap align-items-center");o.style.gap=".5rem";const n=c("span","text-muted small fw-semibold","Ethos:"),r=c("span","ethoscan-widget__compact-score");r.style.color=e.color,r.textContent=e.score.toString();const a=c("span","badge ethoscan-widget__compact-level");a.style.backgroundColor=e.color,a.style.color=C(e.color),a.textContent=e.level;const s=document.createElement("a");s.className="link-primary small text-decoration-none",s.href=e.links.profile,s.target="_blank",s.rel="noopener noreferrer",s.textContent="View Profile";const i=c("span","text-muted small ms-auto");return i.textContent=`${e.reviewStats.positive} Positive · ${e.reviewStats.neutral} Neutral · ${e.reviewStats.negative} Negative`,o.appendChild(n),o.appendChild(r),o.appendChild(a),o.appendChild(s),o.appendChild(i),t.appendChild(o),t}function M(e,t){const o=c("div",`${m} ${m}--error`),n=c("span","ethoscan-widget__error-icon","⚠"),r=c("span","ethoscan-widget__error-message",e);return o.appendChild(n),o.appendChild(r),o}function c(e,t,o){const n=document.createElement(e);return n.className=t,o&&(n.textContent=o),n}function W(e,t){const{element:o,insertionStrategy:n}=t;switch(n){case"after":o.insertAdjacentElement("afterend",e);break;case"before":o.insertAdjacentElement("beforebegin",e);break;case"prepend":o.insertAdjacentElement("afterbegin",e);break;case"append":o.insertAdjacentElement("beforeend",e);break;default:console.error("[Ethoscan] Unknown insertion strategy:",n)}}function E(){const e=document.querySelectorAll(`.${m}`),t=document.querySelectorAll(`section[${v}]`);e.forEach(n=>{n.remove()}),t.forEach(n=>{n.remove()});const o=e.length+t.length;o>0&&console.log(`[Ethoscan] Removed ${o} existing widget(s)`)}function O(e){return!e||typeof e!="string"||!e.startsWith("0x")||e.length!==42?!1:/^0x[0-9a-fA-F]{40}$/.test(e)}function V(e){try{const o=new URL(e).hostname.toLowerCase();return o==="etherscan.io"||o.endsWith(".etherscan.io")?"etherscan":o==="blockscout.com"||o.endsWith(".blockscout.com")?"blockscout":o==="debank.com"?"debank":null}catch{return null}}function U(e){const t=V(e);if(!t)return{address:null,explorer:null,isValid:!1};try{const n=new URL(e).pathname;let r=null;if(t==="etherscan"||t==="blockscout"){const s=n.match(/\/address\/([^\/\?#]+)/);s&&s[1]&&(r=s[1])}else if(t==="debank"){const s=n.match(/\/profile\/([^\/\?#]+)/);s&&s[1]&&(r=s[1])}if(!r)return{address:null,explorer:t,isValid:!1};const a=O(r);return{address:a?r:null,explorer:t,isValid:a}}catch{return{address:null,explorer:t,isValid:!1}}}let f=null,h=null,u=null;async function p(){const e=U(window.location.href);if(e.isValid&&e.address&&e.explorer){if(e.address===f)return;f=e.address,console.log(`[Ethoscan] Address detected: ${e.address} on ${e.explorer}`);const t=await L(e.explorer);if(!t){console.error(`[Ethoscan] Failed to find DOM anchor point for ${e.explorer}`);return}console.log(`[Ethoscan] Found anchor point with ${t.confidence} confidence`);const o=await _(e.address);if(o.success){const n=q(o.data);console.log("[Ethoscan] Rendering widget for:",e.address),b(n,t,e.address,e.explorer)}else console.error("[Ethoscan] API Error:",o.error),b(null,t,e.address,e.explorer)}else f!==null&&(f=null,E(),console.log("[Ethoscan] Cleaned up widgets - no valid address"))}function H(){u=()=>{p()},window.addEventListener("popstate",u),h=window.setInterval(()=>{p()},500)}function z(){u!==null&&(window.removeEventListener("popstate",u),u=null),h!==null&&(clearInterval(h),h=null)}function w(){p(),H()}window.addEventListener("beforeunload",z);document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w):w();
